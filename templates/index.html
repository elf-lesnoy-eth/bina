<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EasyHome ‚Äî Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    .tile { background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); }
    .shadow-soft { box-shadow: 0 10px 30px rgba(0,0,0,.25); }
  </style>
</head>

<body class="min-h-screen bg-[#0b0f14] text-slate-100">
  <div id="app" class="mx-auto max-w-3xl p-4 space-y-5">
    <!-- Header -->
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl grid place-items-center bg-emerald-500/15 text-emerald-300 text-lg">üè†</div>
        <div class="flex items-center gap-2">
          <h1 class="text-xl font-semibold tracking-wide">EasyHome</h1>
          <span class="text-[11px] px-2 py-0.5 rounded-full bg-sky-500/15 text-sky-300 border border-sky-500/30">verified</span>
        </div>
      </div>
      <button id="refreshBtn" class="px-3 py-2 rounded-xl bg-white/5">üîÑ</button>
    </header>

    <!-- Revenue Card -->
    <section class="rounded-2xl p-0 overflow-hidden shadow-soft bg-[#0f141a] border border-white/5">
      <div class="p-4 flex items-start justify-between">
        <div>
          <div class="text-base">–í–∞—à –¥–æ—Ö–æ–¥</div>
          <div id="totalAmount" class="text-4xl font-bold leading-none mt-2">‚Äî</div>
        </div>
        <span class="px-2.5 py-1 rounded-lg text-[12px] bg-amber-400/10 text-amber-300 border border-amber-400/30">‚ö° Energy</span>
      </div>
      <div class="bg-emerald-500 text-slate-900 text-sm font-medium px-4 py-3">
        + –ö–æ–º–∏—Å—Å–∏—è 0% –Ω–∞ –ø–µ—Ä–≤—ã–µ 30 000 ‚ÇΩ
      </div>
      <div class="p-4 text-xs text-slate-400" id="tenantMeta"></div>
      <div class="px-4 pb-4 flex flex-wrap gap-3 text-sm">
        <a id="pdfLink" class="inline-flex items-center gap-1 text-sky-300 hover:text-sky-200 transition-colors" href="#" target="_blank">üìÑ –î–æ–≥–æ–≤–æ—Ä</a>
        <a id="photosLink" class="inline-flex items-center gap-1 text-sky-300 hover:text-sky-200 transition-colors" href="#" target="_blank">üñºÔ∏è –ê–ª—å–±–æ–º</a>
      </div>
    </section>

    <!-- Payments Table -->
    <section id="statsSection" class="rounded-2xl p-4 bg-[#0f141a] border border-white/5">
      <h2 class="text-lg font-semibold mb-3">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-left text-slate-400">
              <th class="py-2 pr-4">–î–∞—Ç–∞</th>
              <th class="py-2 pr-4">–û–ø–∏—Å–∞–Ω–∏–µ</th>
              <th class="py-2 pr-4">–°—É–º–º–∞ (GEL)</th>
            </tr>
          </thead>
          <tbody id="paymentsBody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    console.log("üöÄ EasyHome starting...");

    const TENANTS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTJMucwthLrL_6GLDUUMBJymZEsqZ79nAjQ1eAW7oPU53RYFyh1ocl2Xl0SqUKjBWNaVQ0TlaJqRHRz/pub?gid=2073630276&single=true&output=csv";
    const PAYMENTS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTJMucwthLrL_6GLDUUMBJymZEsqZ79nAjQ1eAW7oPU53RYFyh1ocl2Xl0SqUKjBWNaVQ0TlaJqRHRz/pub?gid=84433962&single=true&output=csv";

    // --- –ø–æ–ª—É—á–∞–µ–º username ---
    const tg = window.Telegram?.WebApp;
    const urlParams = new URLSearchParams(window.location.search);
    const usernameFromUrl = urlParams.get("user");
    const tgUsername = usernameFromUrl || tg?.initDataUnsafe?.user?.username || "";
    const normalized = normalizeUsername(tgUsername);

    console.log("üë§ Username:", tgUsername, "‚Üí normalized:", normalized);

    if (tg) { tg.ready(); tg.expand(); }

    // --- helpers ---
    function normalizeUsername(v) {
      return (v || "").toString().trim().toLowerCase().replace(/^@/, "");
    }

    function parseAmount(v) {
      const n = parseFloat((v || "0").toString().replace(/[^\d.-]/g, ""));
      return isNaN(n) ? 0 : n;
    }

    async function fetchCSV(url) {
      const res = await fetch(url, { cache: "no-store" });
      const text = await res.text();
      return Papa.parse(text, { header: true, skipEmptyLines: true }).data;
    }

    function disableLink(el) {
      if (el) { el.href = "#"; el.classList.add("opacity-50", "pointer-events-none"); }
    }

    function enableLink(el, href) {
      if (el) { el.href = href; el.classList.remove("opacity-50", "pointer-events-none"); }
    }

    function fmt(n) {
      try { return Number(n).toLocaleString("ru-RU", { maximumFractionDigits: 2 }); }
      catch (e) { return n; }
    }

    async function loadAll() {
      console.log("üì° Loading data...");
      let tenants = [], payments = [];
      try {
        [tenants, payments] = await Promise.all([
          fetchCSV(TENANTS_URL),
          fetchCSV(PAYMENTS_URL)
        ]);
      } catch (err) {
        console.error("‚ùå CSV load error:", err);
        document.getElementById("tenantMeta").textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö";
        return;
      }

      const tenant = tenants.find(r => normalizeUsername(r.username) === normalized);
      if (!tenant) {
        document.getElementById("tenantMeta").textContent =
          "‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ username –≤ Telegram —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–∞–±–ª–∏—Ü–µ–π.";
        document.getElementById("totalAmount").textContent = "‚Äî";
        disableLink(document.getElementById("pdfLink"));
        disableLink(document.getElementById("photosLink"));
        document.getElementById("paymentsBody").innerHTML =
          `<tr><td colspan="3" class="py-4 text-center text-slate-400">–ù–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π</td></tr>`;
        return;
      }

      const meta = `–ñ–∏–ª–µ—Ü: ${tenant.name || "‚Äî"} ¬∑ –ö–æ–Ω—Ç—Ä–∞–∫—Ç: ${tenant.contract_start || "‚Äî"} ‚Äî ${tenant.contract_end || "‚Äî"} ¬∑ –ê—Ä–µ–Ω–¥–∞: ${tenant.monthly_rent || "‚Äî"} ‚Çæ ¬∑ –î–µ–ø–æ–∑–∏—Ç: ${tenant.deposit || "‚Äî"} ‚Çæ ¬∑ –ü–∏—Ç–æ–º—Ü—ã: ${tenant.pets || "‚Äî"}`;
      document.getElementById("tenantMeta").textContent = meta;

      const pdfLink = tenant.pdf_link?.trim() || "";
      const photosLink = tenant.photos_links?.trim() || "";
      pdfLink ? enableLink(document.getElementById("pdfLink"), pdfLink) : disableLink(document.getElementById("pdfLink"));
      photosLink ? enableLink(document.getElementById("photosLink"), photosLink) : disableLink(document.getElementById("photosLink"));

      const tbody = document.getElementById("paymentsBody");
      const userPayments = payments.filter(p => normalizeUsername(p.username) === normalized);
      tbody.innerHTML = "";
      let total = 0;
      userPayments.forEach(p => {
        const amt = parseAmount(p.amount);
        total += amt;
        tbody.innerHTML += `<tr>
          <td class="py-2 pr-4">${p.date || "‚Äî"}</td>
          <td class="py-2 pr-4">${p.income_outcome_name || "‚Äî"}</td>
          <td class="py-2 pr-4">${fmt(amt)}</td>
        </tr>`;
      });

      if (userPayments.length === 0) {
        tbody.innerHTML = `<tr><td colspan="3" class="py-4 text-center text-slate-400">–ù–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π</td></tr>`;
      }

      document.getElementById("totalAmount").textContent = total ? `${fmt(total)} GEL` : "‚Äî";
      console.log("üí∞ Total income:", total);
    }

    document.getElementById("refreshBtn").addEventListener("click", loadAll);
    loadAll();
  </script>
</body>
</html>
